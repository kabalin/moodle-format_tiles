define ("format_tiles/course",["jquery","core/templates","core/ajax","format_tiles/browser_storage","core/notification","core/str","format_tiles/tile_fitter","core/fragment"],function(a,b,c,d,e,f,g,h){"use strict";var i=a("body"),j=a("body, html"),k,l,m=[],n,o=!1,p=!1,q=60,r=!1,s=0,t,u,v=!1,w,x=0,y={PAGE:"#page",TILE:".tile",TILEID:"#tile-",MOVEABLE_SECTION:".moveablesection",FILTER_BUTTON:".filterbutton",TILE_LOADING_ICON:".tile-loading-icon",TILE_LOADING_ICON_ID:"#loading-icon-",TILE_COLLAPSED:".tile-collapsed",TILE_CLICKABLE:".tile-clickable",TILES:"ul.tiles",ACTIVITY:".activity",SPACER:".spacer",SECTION_MOVEABLE:".moveablesection",SECTION_ID:"#section-",SECTION_TITLE:".sectiontitle",SECTION_MAIN:".section.main",SECTION_BUTTONS:".sectionbuttons",CLOSE_SEC_BTN:".closesectionbtn",HIDE_SEC0_BTN:"#buttonhidesec0",SECTION_ZERO:"#section-0",MOODLE_VIDEO:".mediaplugin.mediaplugin_videojs",LAUNCH_STANDARD:"[data-action=\"launch-tiles-standard\"]",TOOLTIP:"[data-toggle=tooltip]",HEADER_BAR:["header.navbar","nav.fixed-top.navbar","#essentialnavbar.moodle-has-zindex","#navwrap","nav.navbar-fixed-top","#adaptable-page-header-wrapper"],MATHJAX_EQUATION:".filter_mathjaxloader_equation"},z={SELECTED:"selected",OPEN:"open",CLOSED:"closed",LAUNCH_CM_MODAL:"launch-tiles-cm-modal",STATE_VISIBLE:"state-visible"},A={CLICK:"click",KEYDOWN:"keydown",SCROLL:"scroll"},B={DISPLAY:"display",Z_INDEX:"z-index",HEIGHT:"height",BG_COLOUR:"background-color"},C={ESCAPE:27,TAB:9,RETURN:13},D=function(b){var c=a(y.SECTION_ID+b);c.find("iframe").each(function(b,c){c=a(c);if(c.attr("src")){c.attr("data-src",c.attr("src"));c.attr("src","")}});var d=c.find(y.MOODLE_VIDEO);if(0<d.length){c.html("")}},E=function(b){a(y.MOVEABLE_SECTION).each(function(b,c){c=a(c);if(c.is(":visible")){D(c.attr("data-section"));c.slideUp().removeClass(z.STATE_VISIBLE)}});a(y.TILE).removeClass(z.SELECTED).css(B.Z_INDEX,"").css(B.BG_COLOUR,"");a(".section "+z.SELECTED).removeClass(z.SELECTED).css(B.Z_INDEX,"");n.fadeOut(300);if(b!==void 0&&0!==b){a(y.TILEID+b).focus()}a(y.TILE_LOADING_ICON).fadeOut(300,function(){a(y.TILE_LOADING_ICON).html("")});p=!1;x=0},F=function(b,c){if(c){b.html(c);a(y.TILE_LOADING_ICON).fadeOut(300,function(){a(y.TILE_LOADING_ICON).html("")});if(b.attr("id")!==y.SECTION_ZERO){var e=b.find(y.ACTIVITY).not(y.SPACER);b.on(A.KEYDOWN,function(c){if(c.keyCode===C.ESCAPE){d.setLastVisitedSection(0);E(0);a(y.TILEID+b.attr("data-section")).focus()}});e.on(A.KEYDOWN,function(b){if(b.keyCode===C.RETURN){var c=a(b.currentTarget).find("a");if(c.hasClass(z.LAUNCH_CM_MODAL)){c.click()}else if(c.attr("href")!==void 0){window.location=c.attr("href")}}});if(!k){e.last().on(A.KEYDOWN,function(c){if(c.keyCode===C.TAB&&!c.shiftKey&&a(c.relatedTarget).closest(y.SECTION_MAIN).attr("id")!==b.attr("id")){setTimeout(function(){b.find(y.SECTION_TITLE).focus();j.animate({scrollTop:b.offset().top-q},"slow");b.find(y.SECTION_BUTTONS).css("top","")},200)}});b.find(y.SECTION_TITLE).on(A.KEYDOWN,function(c){if(c.keyCode===C.TAB&&c.shiftKey&&a(c.relatedTarget).closest(y.SECTION_MAIN).attr("id")!==b.attr("id")){setTimeout(function(){e.last().focus()},200)}})}}if(!k){setTimeout(function(){try{var a=b.find(".badge-info");if(0<a.length&&"function"==typeof a.tooltip){a.tooltip()}}catch(a){require(["core/log"],function(b){b.debug(a)})}},500)}if(0!==b.find(y.MOODLE_VIDEO).length){require(["media_videojs/loader"],function(a){a.setUp()})}G(b);return!0}return!1},G=function(a){if("undefined"!=typeof window.MathJax){try{var b=a.find(y.MATHJAX_EQUATION);if(b.length){b.each(function(a,b){window.MathJax.Hub.Queue(["Typeset",window.MathJax.Hub,b])})}}catch(a){require(["core/log"],function(b){b.debug(a)})}}},H=function(b,c){var d=function(){var d=a("#tileText-"+c).offset().top-q;if(d===a(window).scrollTop){d+=1}b.find(y.SECTION_TITLE).focus();i.on("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove",function(){i.stop()});j.animate({scrollTop:d},"slow",function(){j.off("scroll mousedown wheel DOMMouseScroll mousewheel keyup touchmove",function(){j.stop()})});p=!0;x=c;b.find(y.ACTIVITY).first().focus();var e=b.find("iframe");if(0<e.length){e.each(function(b,c){c=a(c);if(""===c.attr("src")&&c.attr("data-src")!==void 0){c.attr("src",c.attr("data-src"))}});if(w){require(["format_tiles/completion"],function(a){setTimeout(function(){a.updateTileInformation()},1e3)})}}},e=function(){var c=b.find(y.SECTION_BUTTONS);a(window).on(A.SCROLL,function(){if(!o&&p){o=!0;c.fadeOut(300);setTimeout(function(){var d=a(window).scrollTop(),e=d-b.offset().top+50;if(0<e&&e<b.outerHeight()-100){e=d-b.offset().top+50;c.css("top",e);if("none"===n.css(B.DISPLAY)){n.fadeIn(300)}}else if(0>e){c.css("top",0)}if(d>b.offset().top+b.outerHeight()-50){if("block"===n.css(B.DISPLAY)){n.fadeOut(300)}c.css("top",0)}else if(b.offset().top>d+a(window).outerHeight()){if("block"===n.css(B.DISPLAY)){n.fadeOut(300)}c.css("top",0)}else if("none"===n.css(B.DISPLAY)){n.fadeIn(300)}c.fadeIn(300,function(){o=!1})},500)}});if(!o&&!p&&n.is(":visible")){n.fadeOut(300)}};b.addClass(z.STATE_VISIBLE);b.slideDown(350,function(){d();e()});x=c},I=function(b,c){var d=new a.Deferred,e=a(".moveablesection:visible"),f=0;if(0<e.length){f=e.attr("data-section");E()}var h=function(a){g.runReOrg(a).done(function(a){if(0!==f){H(e,f)}d.resolve(a)}).fail(function(a){if(0!==f){H(e,f)}d.reject(a)})};if(c){setTimeout(function(){g.resizeTilesDivWidth(t).done(function(){h(!1)},b)})}else{h(b)}return d.promise()},J=function(a,b,c){if(b){e.confirm(m.sectionerrortitle,m.sectionerrorstring,m.refresh,m.cancel,function(){window.location.reload()},null);c.html("")}else{F(c,"<p>"+m.noconnectionerror+"</p>");setTimeout(function(){H(c,a)},500)}require(["core/log"],function(a){a.debug(b)});throw new Error("Not successful retrieving tile content by AJAX for section "+a)},K=function(a,b){return h.loadFragment("format_tiles","get_single_section_page",u,{courseid:a,sectionid:b,setjsusedsession:!0})},L=function(a,c,d,e){var f=0>e?0:255,h=0>e?-1*e:e,i=Math.round((f-a)*h)+a,j=Math.round((f-c)*h)+c,g=Math.round((f-d)*h)+d;return"rgb("+i+","+j+","+g+")"},M=function(b){n.fadeIn(300);s=parseInt(n.css(B.Z_INDEX));var c=a(y.TILEID+b);c.css(B.Z_INDEX,s+1);a(y.SECTION_ID+b).css(B.Z_INDEX,s+1);if(c.css(B.BG_COLOUR)&&"rgba"===c.css(B.BG_COLOUR).substr(0,4)){var d=c.css(B.BG_COLOUR).replace("rgba(","").replace(")","").replace(" ","").split(",");c.css(B.BG_COLOUR,L(parseInt(d[0]),parseInt(d[1]),parseInt(d[2]),.95))}},N=function(b){var c=a(b.currentTarget);if("window-overlay"===c.attr("id")){c.hide();var d=a(document.elementFromPoint(b.clientX,b.clientY));c.show();if("window-overlay"===c.attr("id")){if(d.hasClass("filterbutton")||d.hasClass("list-group-item")){d.click()}else{var e=d.closest(y.TILE);if(e){e.click()}}}else{E(0);d.click()}}},O=function(){var b=a(y.HIDE_SEC0_BTN),c=a(y.SECTION_ZERO);if(d.storageEnabledLocal()){if(!0===d.getSecZeroCollapseStatus()){c.slideUp(0);b.addClass(z.CLOSED).removeClass(z.OPEN)}else{c.slideDown(300);b.addClass(z.OPEN).removeClass(z.CLOSED)}}else{b.addClass(z.OPEN).removeClass(z.CLOSED);c.slideDown(300)}},P=function(f,g,h){M(h);a(y.TILE).removeClass(z.SELECTED);g.addClass(z.SELECTED);x=h;a(y.MOVEABLE_SECTION).each(function(b,c){c=a(c);if(c.is(":visible")){D(c.attr("data-section"));c.slideUp(200).removeClass(z.STATE_VISIBLE)}});c.call([{methodname:"format_tiles_log_tile_click",args:{courseid:f,sectionid:h}}])[0].fail(e.exception);var i=a(y.SECTION_ID+h);if(0<i.find(y.ACTIVITY).length){H(i,h);K(f,h).done(function(a,c){F(i,a);b.runTemplateJS(c)})}else{i.html(l);K(f,h).done(function(a,c){F(i,a);b.runTemplateJS(c);H(i,h)}).fail(function(a){J(h,a,i);E(h)})}d.setLastVisitedSection(h)};return{init:function init(e,h,j,o,p,q,D,H,J,L,M){t=e;u=h;k=o;r="1"===H;q=1===q;D="1"===D;w="1"===M;d.init(t,!1,p,D,J);a(document).ready(function(){var e=a("#page-content");if(0===e.length){e=a("#region-main")}if(0!==p){x=p}else{if(r&&d.storageEnabledLocal){x=d.getLastVisitedSection()}}if(0!==x){g.init(t,x,L,!1)}else{a(y.TILEID+"1").focus();g.init(t,null,L,!1)}var h=a(window).outerWidth();if(j){n=a("<div></div>").addClass("modal-backdrop fade in").hide().attr("id","window-overlay").appendTo(i);n.click(function(a){E(0);N(a)});e.on(A.CLICK,y.TILE_CLICKABLE,function(c){if(!j){return}c.preventDefault();a(window).off(A.SCROLL);a(y.TILE_LOADING_ICON).fadeOut(300,function(){a(y.TILE_LOADING_ICON).html()});var e=a(c.currentTarget).closest(y.TILE),f=parseInt(e.attr("data-section"));if(e.hasClass(z.SELECTED)){E(f);d.setLastVisitedSection(0)}else{P(t,e,f)}var g=a(y.SECTION_ID+(f+1)),h=1===a(".filters-config[data-filter=\"h5p\"]").length;if(!k&&!h&&g.length&&0<f){K(t,f+1).done(function(a,c){F(g,a);b.runTemplateJS(c)})}});a(window).on("resize",function(){if(v||h===a(window).outerWidth()){return}v=!0;setTimeout(function(){var b=!0,c=a(".moveablesection:visible");if(0!==c.length){var d=c.find(".mediaplugin iframe");if(0!==d.length){d.each(function(d,e){e=a(e);if(e.outerWidth()>c.outerWidth()){b=!1}})}}if(b){h=a(window).outerWidth();I(!0,L)}v=!1},600)});var o=parseInt(n.css(B.Z_INDEX)),u=a(y.HEADER_BAR.find(function(b){return 0<a(b).length}));if(u!==void 0&&0!==u.length){u.css(B.Z_INDEX,o+3)}e.on(A.CLICK,y.CLOSE_SEC_BTN,function(b){E(a(b.currentTarget).attr("data-section"))});e.on(A.CLICK,y.LAUNCH_STANDARD,function(b){var c=a(b.currentTarget);if(c.attr("href")!==void 0){window.location=c.attr("href")}else if(c.find("a").attr("href")!==void 0){window.location=c.find("a").attr("href")}});O()}a(document).on("format-tiles-completion-changed",function(d,e){var f=a(y.TILE).not(y.SPACER).map(function(b,c){return parseInt(a(c).attr("data-section"))}).toArray();f.push(0);K(t,e.section).done(function(c,d){F(a(y.SECTION_ID+e.section),c);b.runTemplateJS(d)}).catch(function(a){require(["core/log"],function(b){b.debug(a)})});c.call([{methodname:"format_tiles_get_section_information",args:{courseid:t,sectionnums:f}}])[0].done(function(a){require(["format_tiles/completion"],function(b){b.updateSectionsInfo(a.sections,a.overall.complete,a.overall.outof)})}).catch(function(a){require(["core/log"],function(b){b.debug(a)})})});e.on(A.CLICK,y.HIDE_SEC0_BTN,function(b){var c=a(y.SECTION_ZERO);if("none"===c.css(B.DISPLAY)){c.slideDown(250);a(b.currentTarget).addClass(z.OPEN).removeClass(z.CLOSED);d.setSecZeroCollapseStatus("collapsed")}else{c.slideUp(250);a(b.currentTarget).addClass(z.CLOSED).removeClass(z.OPEN);d.setSecZeroCollapseStatus("expanded")}});if(q){require(["format_tiles/filter_buttons"],function(a){a.init(t,d.storageEnabledLocal)});if(j){e.on(A.CLICK,y.FILTER_BUTTON,function(){E(0);I(!0,!1)})}}a(".tiles_coursenav").removeClass("hidden");b.render("format_tiles/loading",{}).done(function(a){l=a});var w=[{key:"sectionerrortitle",component:"format_tiles"},{key:"sectionerrorstring",component:"format_tiles"},{key:"refresh"},{key:"cancel"},{key:"noconnectionerror",component:"format_tiles"},{key:"show"},{key:"hide"},{key:"other",component:"format_tiles"},{key:"blockedpopuptitle",component:"format_tiles"}];f.get_strings(w).done(function(a){a.forEach(function(b,c){if(b){m[w[c].key]=b}else{m[w[c].key]="Error.";require(["core/log"],function(b){b.debug("Format tiles get_strings error ".concat(c));b.debug(a)})}})}).fail(function(a){require(["core/log"],function(b){b.debug(a)})});if(k){e.on(A.CLICK,y.ACTIVITY+".video a",function(b){var d=a(b.currentTarget),e=d.closest(y.ACTIVITY).attr("data-url-secondary");if(e!==void 0){b.preventDefault();b.stopPropagation();var f=d.closest(y.ACTIVITY);c.call([{methodname:"format_tiles_log_mod_view",args:{courseid:t,cmid:f.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(a){a.markAsAutoCompleteInUI(t,f)})});window.location=e}})}else{a(y.TILE).on(A.KEYDOWN,function(b){if(b.keyCode===C.RETURN){a(b.currentTarget).click()}});a("ul.tiles .tile").first().focus()}a(document).on("filter-content-updated",function(b,c){if(0<c.length){var d=a(c[0]);if(d.hasClass("moodle-dialogue")&&d.css("z-index")<s){d.css("z-index",s+1)}}});var D=a(".filters-config[data-filter=\"mathjaxloader\"]");if(D.length){if("undefined"==typeof window.MathJax){var H=a("<script/>");H.attr("src",D.attr("data-url")).attr("type","text/javascript").html(D.attr("data-config"));a("head").append(H);setTimeout(function(){G(a("#multi_section_tiles"))},2e3)}}})}}});
//# sourceMappingURL=course.min.js.map

function _typeof(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(a){return typeof a}}else{_typeof=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return _typeof(a)}define ("format_tiles/course_mod_modal",["jquery","core/modal_factory","core/config","core/templates","core/notification","core/ajax","core/fragment"],function(a,b,c,d,f,g,h){"use strict";var i={},j,k=a(window),l,m={completioncheckbox:".completioncheckbox",completionAuto:".completion-auto",modal:".modal",modalDialog:".modal-dialog",modalBody:".modal-body",sectionMain:".section.main",pageContent:"#page-content",regionMain:"#region-main",completionState:"#completion-check-",cmModalClose:".embed_cm_modal .close",cmModal:".embed_cm_modal",moodleMediaPlayer:".mediaplugin_videojs",urlModalLoadWarning:"#embed-url-error-msg-",closeBtn:"button.close",ACTIVITY:"li.activity",URLACTIVITYPOPUPLINK:".activity.modtype_url.urlpopup a",newWindowButton:".button_expand",modalHeader:".modal-header",embedModuleButtons:".embed-module-buttons",iframe:"iframe"},n={COMPLETION_MANUAL:"completeonmanual",COMPLETION_AUTO:"completion-auto"},o={launchResourceModal:"launch-tiles-resource-modal",launchModuleModal:"launch-tiles-module-modal",launchUrlModal:"launch-tiles-url-modal"},p=function(){return Math.min(k.width(),1100)},q=function(b){var c=b.find(m.iframe);if(0<c.length){b.find(m.closeBtn).click(function(b){a(b.currentTarget).closest(m.cmModal).find(m.iframe).each(function(b,c){c=a(c);c.attr("src",c.attr("src"))})})}var d=b.find("object");if(0<d.length){b.find(m.closeBtn).click(function(b){var c=a(b.currentTarget).closest(m.cmModal);c.find("object").each(function(b,c){c=a(c);c.attr("data","")});i[c.attr("data-cmid")]=void 0})}var e=b.find(m.moodleMediaPlayer);if(0<e.length){b.find(m.closeBtn).click(function(){b.find(m.moodleMediaPlayer).html("")});i[b.attr("data-cmid")]=void 0}},r=function(e){var g=e.attr("data-cmid");b.create({type:b.types.DEFAULT,title:e.attr("data-title"),body:j}).done(function(b){i[g]=b;b.setLarge();b.show();var h=a(b.root);h.attr("id","embed_mod_modal_"+g);h.attr("data-cmid",g);h.addClass("embed_cm_modal");var j=e.closest(m.sectionMain).attr("data-section"),l={id:g,pluginfileUrl:e.attr("data-url"),objectType:"text/html",width:"100%",height:Math.round(k.height()-60),cmid:g,tileid:j,isediting:0,sesskey:c.sesskey,modtitle:e.attr("data-title"),config:{wwwroot:c.wwwroot},showDownload:0,showNewWindow:0,completionInUseForCm:0,completionstring:""};if("resource_pdf"===e.attr("data-modtype")){l.objectType="application/pdf";l.showDownload=1;l.showNewWindow=1}d.render("format_tiles/embed_file_modal_body",l).done(function(a){b.setBody(a);h.find(m.modalBody).animate({"min-height":Math.round(k.height()-60)},"fast");if("resource_html"===e.attr("data-modtype")){h.find(m.modal).animate({"max-width":"100%"},"fast");h.find(m.modalDialog).animate({"max-width":"100%"},"fast");h.find(m.modalBody).animate({"max-width":"100%"},"fast");q(h)}else{h.find(m.modal).animate({"max-width":p()},"fast");h.find(m.modalDialog).animate({"max-width":p()},"fast")}}).fail(f.exception);var o=e.find(m.completioncheckbox);if(0!==o.length){l.completionstate=e.hasClass(n.COMPLETION_AUTO)?1:parseInt(o.attr("data-completionstate"));l.completionInUseForCm=1;l.completionicon=1===l.completionstate?"y":"n";l.completionstateInverse=1-l.completionstate;l.completionIsManual=e.hasClass(n.COMPLETION_MANUAL);l.completionstring=o.attr("title");require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(j)})}d.render("format_tiles/embed_module_modal_header_btns",l).done(function(a){h.find(m.modalHeader).append(a);h.find(m.closeBtn).detach().appendTo(h.find(m.embedModuleButtons))}).fail(f.exception);return!0});return!1},s=function(e){var g=e.attr("data-cmid");b.create({type:b.types.DEFAULT,title:e.attr("data-title"),body:j}).done(function(b){i[g]=b;b.setLarge();b.show();var h=a(b.root);h.attr("id","embed_mod_modal_"+g);h.attr("data-cmid",g);h.addClass("embed_cm_modal");var j=Math.round(.9*k.width()),l=Math.round(.9*k.height()),o=e.closest(m.sectionMain).attr("data-section"),p={id:g,pluginfileUrl:e.attr("data-url"),objectType:"text/html",width:j-30,height:l-30,cmid:g,tileid:o,isediting:0,sesskey:c.sesskey,modtitle:e.attr("data-title"),config:{wwwroot:c.wwwroot},showDownload:0,showNewWindow:1,completionInUseForCm:0,secondaryurl:e.closest(m.ACTIVITY).attr("data-url-secondary")};d.render("format_tiles/embed_url_modal_body",p).done(function(a){b.setBody(a);h.find(m.modalBody).animate({"min-height":l},"fast");h.find(m.modal).animate({"max-width":j},"fast");h.find(m.modalDialog).animate({"max-width":j},"fast");h.find(m.modalBody).animate({"max-width":j},"fast");q(h);h.find(m.modalBody).addClass("text-center")}).fail(f.exception);var r=e.find(m.completioncheckbox);if(0!==r.length){p.completionstate=e.hasClass(n.COMPLETION_AUTO)?1:parseInt(r.attr("data-completionstate"));p.completionInUseForCm=1;p.completionicon=1===p.completionstate?"y":"n";p.completionstateInverse=1-p.completionstate;p.completionIsManual=e.hasClass(n.COMPLETION_MANUAL);p.completionstring=r.attr("title");require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(o)})}d.render("format_tiles/embed_module_modal_header_btns",p).done(function(a){h.find(m.modalHeader).append(a);h.find(m.closeBtn).detach().appendTo(h.find(m.embedModuleButtons))}).fail(f.exception);setTimeout(function(){h.find(m.newWindowButton).click(function(){i[h.attr("data-cmid")].hide();i[h.attr("data-cmid")]=void 0;h.remove();a(".modal-backdrop").not("#window-overlay").removeClass("show").addClass("hide")})},1e3);return!0});return!1},t=function(b){b.find(m.modal).animate({"max-width":p()},"fast");var c=a(m.moodleMediaPlayer);c.find("div").each(function(b,c){a(c).css("max-width","")});if(0<c.length){q(b)}b.find(m.iframe).each(function(c,d){var e=b.find(m.modalDialog);if(0===e.length){e=b.find(m.modal)}var f=Math.min(a(d).width(),k.width());if(f>e.width()-70){e.animate({"max-width":Math.max(f+70,p())},"fast");b.find(m.modal).animate({"max-width":Math.max(f+70,p())},"fast")}var g=Math.min(a(d).height(),k.height()),h=b.find(m.modalBody);if(g>h.height()-70){h.animate({"min-height":Math.min(g+70,k.height())+1},"fast")}q(b)})},u=function(a,b,c){var d=3<arguments.length&&arguments[3]!==void 0?arguments[3]:0,e=a.find(m.modalBody);if(e){var f=Math.round(e.height());if(f&&f>d+10){t(a)}if(0<b){setTimeout(function(){u(a,b-1,c,f)},c)}}},v=function(e){var g=e.data("cmid"),k=e.data("contextid"),l="get_mod_"+e.data("modtype"),o;b.create({type:b.types.DEFAULT,title:e.data("title"),body:j}).then(function(b){i[g]=b;b.setLarge();b.show();o=a(b.root);o.attr("data-cmid",g);o.attr("id","embed_mod_modal_"+g);o.addClass("embed_cm_modal");o.addClass("mod_"+e.data("modtype"));q(o);return h.loadFragment("format_tiles",l,k,{})}).then(function(a,b){var c=e.closest(m.sectionMain).data("section"),h={cmid:g,modtitle:e.data("title"),tileid:c,content:a},j=e.find(m.completioncheckbox);if(0!==j.length){h.completionstate=e.hasClass(n.COMPLETION_AUTO)?1:parseInt(j.data("completionstate"));h.completionInUseForCm=1;h.completionicon=1===h.completionstate?"y":"n";h.completionstateInverse=1-h.completionstate;h.completionIsManual=e.hasClass(n.COMPLETION_MANUAL);h.completionstring=j.attr("title");require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(c)})}i[g].setBody(h.content);d.runTemplateJS(b);d.render("format_tiles/embed_module_modal_header_btns",h).done(function(a){o.find(m.modalHeader).append(a);o.find(m.closeBtn).detach().appendTo(o.find(m.embedModuleButtons))}).fail(f.exception);setTimeout(function(){u(o,3,1e3)},500)}).fail(function(a){if(!0!==c.developerdebug){window.location=c.wwwroot+"/mod/"+e.attr("data-modtype")+"/view.php?id="+g}else{f.exception(a)}});return!1},w=function(b){var c=a(b.currentTarget).closest(m.ACTIVITY);if(c.attr("data-url")!==void 0){b.stopPropagation();b.preventDefault();g.call([{methodname:"format_tiles_log_mod_view",args:{courseid:l,cmid:c.attr("data-cmid")}}])[0].done(function(){require(["format_tiles/completion"],function(a){a.markAsAutoCompleteInUI(l,c)});var a=window.open(c.attr("data-url"));try{a.focus()}catch(a){var b="<div><a href=\""+c.attr("data-url")+"\">"+c.attr("data-url")+"</a></div>";require(["core/str","core/notification"],function(a,c){a.get_strings([{key:"sectionerrortitle",component:"format_tiles"},{key:"blockedpopup",component:"format_tiles"},{key:"cancel"}]).done(function(a){c.alert(a[0],a[1]+b,a[2])})})}}).fail(f.exception)}};return{init:function init(b,c){l=b;a(document).ready(function(){var b=Object.keys(o).map(function(a){return"[data-action=\""+o[a]+"\"]"}).join(", "),e=a(m.pageContent);if(0===e.length){e=a(m.regionMain)}e.on("click",b,function(b){b.preventDefault();var c=a(b.currentTarget),d=c.closest("li.activity"),e=i[d.attr("data-cmid")];if("object"===_typeof(e)){e.show()}else{switch(c.attr("data-action")){case o.launchModuleModal:v(d);break;case o.launchResourceModal:r(d);break;case o.launchUrlModal:s(d);break;default:throw new Error("Unknown modal type "+c.attr("data-action"));}g.call([{methodname:"format_tiles_log_mod_view",args:{courseid:l,cmid:d.attr("data-cmid")}}])[0].fail(f.exception)}if(0!==d.find(m.completionAuto).length){require(["format_tiles/completion"],function(a){a.triggerCompletionChangedEvent(d.closest(m.sectionMain).attr("data-section"))})}});d.render("format_tiles/loading",{}).catch(f.exception).done(function(a){j=a}).fail(f.exception);if(!c){e.on("click",m.URLACTIVITYPOPUPLINK,function(a){w(a)})}})}}});
//# sourceMappingURL=course_mod_modal.min.js.map
